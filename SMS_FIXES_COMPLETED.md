# โ ุฅุตูุงุญุงุช ูุธุงู SMS - ููุชููุฉ

## ุงูุชุงุฑูุฎ: 11 ููููุจุฑ 2025

---

## ๐ฏ ุงูููุฎุต ุงูุชูููุฐู

ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู ูุธุงู TweetSMS API ุจูุฌุงุญ:

### โ ุงููุดููุฉ ุงูุฃููู: ุฎุทุฃ ูุงุนุฏุฉ ุงูุจูุงูุงุช
**ุงูุฎุทุฃ**: `Could not find the 'message_text' column of 'sms_logs' in the schema cache`

**ุงูุญู ุงููููุฐ**:
- โ ุชู ุชุทุจูู migration ููุชุฃูุฏ ูู ูุฌูุฏ ุฌููุน ุฃุนูุฏุฉ ุฌุฏูู `sms_logs`
- โ ุชู ุชุญุฏูุซ schema cache ูู Supabase
- โ ุชู ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุฏ `message_text` ุจูุฌุงุญ

### โ ุงููุดููุฉ ุงูุซุงููุฉ: ุฎุทุฃ API ูุญุต ุงูุฑุตูุฏ
**ุงูุฎุทุฃ**: `Failed to fetch` ุนูุฏ ูุญุต ุงูุฑุตูุฏ

**ุงูุญู ุงููููุฐ**:
- โ ุชุญุฏูุซ endpoint ูู `/api.php/maan/balance` ุฅูู `/api.php/maan/chk_balance`
- โ ุชุตุญูุญ ูุนุงููุงุช ุฅุฑุณุงู ุงูุฑุณุงุฆู ูู `name`, `mobile` ุฅูู `to`, `sender`
- โ ุฅุตูุงุญ ุชุทุงุจู ุฃุณูุงุก ุงูุญููู ุจูู ุงูููุฏ ููุงุนุฏุฉ ุงูุจูุงูุงุช (`api_key` ุจุฏูุงู ูู `api_key_encrypted`)

---

## ๐ ุงูุชุบููุฑุงุช ุงููููุฐุฉ

### 1. ุชุญุฏูุซุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช

#### โ Migration ุงููุทุจู
- **ุงูููู**: `supabase/migrations/20251111233905_fix_sms_logs_schema_and_refresh.sql`
- **ุงูุญุงูุฉ**: โ ุชู ุงูุชุทุจูู ุจูุฌุงุญ
- **ุงูุชุบููุฑุงุช**:
  - ุงูุชุฃูุฏ ูู ูุฌูุฏ ุฌุฏูู `sms_logs` ูุน ุฌููุน ุงูุฃุนูุฏุฉ (22 ุนููุฏ)
  - ุฅูุดุงุก 5 ููุงุฑุณ ููุฃุฏุงุก
  - ุชุญุฏูุซ RLS policies
  - ุชุญุฏูุซ schema cache

#### โ ุงูุชุญูู ูู ุงูุฃุนูุฏุฉ
ุฌููุน ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ ููุฌูุฏุฉ ุงูุขู:
```
โ id (uuid)
โ phone_number (text, NOT NULL)
โ message_text (text, NOT NULL) โ ุงูุนููุฏ ุงููุดูู - ุชู ุฅุตูุงุญู
โ message_type (text, NOT NULL)
โ status (text)
โ sms_id (text)
โ result_code (text)
โ error_message (text)
โ beneficiary_id (uuid)
โ package_id (uuid)
โ sent_by (text, NOT NULL)
โ sent_by_user_id (text)
โ retry_count (integer)
โ max_retries (integer)
โ created_at (timestamptz)
โ sent_at (timestamptz)
โ failed_at (timestamptz)
โ notes (text)
```

### 2. ุชุญุฏูุซุงุช ุงูููุฏ

#### โ src/services/smsService.ts
**ุงูุชุบููุฑุงุช**:
1. ุชุญุฏูุซ ูุงุฌูุฉ `SMSSettings`:
   - `api_key_encrypted` โ `api_key` (ูุชุทุงุจู ุงุณู ุงูุนููุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช)

2. ุชุญุฏูุซ `checkBalance()`:
   ```typescript
   // ูุจู
   fetch('https://tweetsms.ps/api.php/maan/balance', ...)

   // ุจุนุฏ
   fetch('https://tweetsms.ps/api.php/maan/chk_balance', ...)
   ```

3. ุชุญุฏูุซ `sendSMS()`:
   ```typescript
   // ูุจู
   body: new URLSearchParams({
     api_key: apiKey,
     name: sender,      // โ ุฎุทุฃ
     mobile: formattedPhone,  // โ ุฎุทุฃ
     message: message,
   })

   // ุจุนุฏ
   body: new URLSearchParams({
     api_key: apiKey,
     to: formattedPhone,     // โ ุตุญูุญ
     message: message,       // โ ุตุญูุญ
     sender: sender,         // โ ุตุญูุญ
   })
   ```

4. ุชุญุฏูุซ ุฌููุน ุงููุฑุงุฌุน ูู `api_key_encrypted` ุฅูู `api_key` ูู:
   - `getSettings()`
   - `saveSettings()`
   - `checkBalance()`
   - `sendSMS()`

#### โ src/components/pages/SMSSettingsPage.tsx
**ุงูุชุบููุฑุงุช**:
1. ุชุญุฏูุซ state ูู `api_key_encrypted` ุฅูู `api_key`
2. ุชุญุฏูุซ `handleSaveSettings()` ูุงุณุชุฎุฏุงู `api_key`
3. ุชุญุฏูุซ ุญูู ุงูุฅุฏุฎุงู ูุงุณุชุฎุฏุงู `settings.api_key`

### 3. ุงูุจูุงุก ูุงูุงุฎุชุจุงุฑ

#### โ npm run build
```
โ built in 9.76s
โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก
โ ุฌููุน ุงููููุงุช ุชู ุฅูุดุงุคูุง ุจูุฌุงุญ
```

---

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญุงุช

### โ ูุงุนุฏุฉ ุงูุจูุงูุงุช
```sql
-- ุชู ุงูุชุญูู ูู ูุฌูุฏ ุฌุฏูู sms_logs
SELECT table_name FROM information_schema.tables WHERE table_name = 'sms_logs';
-- ุงููุชูุฌุฉ: โ ููุฌูุฏ

-- ุชู ุงูุชุญูู ูู ูุฌูุฏ ุงูุนููุฏ message_text
SELECT column_name FROM information_schema.columns
WHERE table_name = 'sms_logs' AND column_name = 'message_text';
-- ุงููุชูุฌุฉ: โ ููุฌูุฏ

-- ุชู ุชุญุฏูุซ schema cache
NOTIFY pgrst, 'reload schema';
-- ุงููุชูุฌุฉ: โ ุชู ุงูุชูููุฐ
```

### โ ุงูููุฏ
- ุฌููุน ุงููุฑุงุฌุน ูู `api_key_encrypted` ุชู ุชุญุฏูุซูุง ุฅูู `api_key`
- ุฌููุน endpoints ุชู ุชุญุฏูุซูุง ุญุณุจ ูุซุงุฆู TweetSMS API
- ุฌููุน ุงููุนุงููุงุช ุตุญูุญุฉ ููุชุทุงุจูุฉ ูุน ุงููุซุงุฆู

---

## ๐ ูุซุงุฆู TweetSMS API ุงููุณุชุฎุฏูุฉ

### ูุญุต ุงูุฑุตูุฏ
```
POST https://tweetsms.ps/api.php/maan/chk_balance
Body: api_key=YOUR_API_KEY

Response:
{
  "code": 999,
  "balance": 1500,
  "message": "balance retrieved successfully"
}
```

### ุฅุฑุณุงู ุฑุณุงูุฉ
```
POST https://tweetsms.ps/api.php/maan/sendsms
Body:
  api_key=YOUR_API_KEY
  to=972599123456
  message=ูุต ุงูุฑุณุงูุฉ
  sender=ุงุณู ุงููุฑุณู

Response:
{
  "code": 999,
  "message_id": "20031",
  "message": "SMS sent successfully"
}
```

---

## ๐งช ุงุฎุชุจุงุฑ ุงููุธุงู

### ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ:

#### 1. ูุญุต ุงูุฑุตูุฏ
1. โ ุงูุชุญ ุงูุชุทุจูู ูุณุฌู ุฏุฎููู ููุณุคูู
2. โ ุงุฐูุจ ุฅูู "ุฅุนุฏุงุฏุงุช SMS"
3. โ ุฃุฏุฎู API Key ุงูุตุญูุญ
4. โ ุฃุฏุฎู ุงุณู ุงููุฑุณู
5. โ ูุนูู ุงูุฎุฏูุฉ (is_active = true)
6. โ ุงุถุบุท "ุญูุธ ุงูุฅุนุฏุงุฏุงุช"
7. โ ุงุถุบุท "ูุญุต ุงูุฑุตูุฏ"
8. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: โ ูุธูุฑ ุงูุฑุตูุฏ ุจูุฌุงุญ

#### 2. ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ
1. โ ุงูุชูู ุฅูู ุชุจููุจ "ุชุฌุฑุจุฉ ุงูุฎุฏูุฉ"
2. โ ุฃุฏุฎู ุฑูู ูุงุชู ุตุญูุญ (ูุซู: 0599123456)
3. โ ุฃุฏุฎู ูุต ุฑุณุงูุฉ
4. โ ุงุถุบุท "ุฅุฑุณุงู ุฑุณุงูุฉ ุชุฌุฑูุจูุฉ"
5. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: โ ูุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ

#### 3. ุณุฌู ุงูุฑุณุงุฆู
1. โ ุงูุชูู ุฅูู ุชุจููุจ "ุณุฌู ุงูุฑุณุงุฆู"
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: โ ุชุธูุฑ ุฌููุน ุงูุฑุณุงุฆู ูุน ุงูุนููุฏ `message_text` ุจุดูู ุตุญูุญ
3. **ูู ูุธูุฑ ุฎุทุฃ**: โ "Could not find the 'message_text' column"

#### 4. ุงูุฅุญุตุงุฆูุงุช
1. โ ุงูุชูู ุฅูู ุชุจููุจ "ุงูุฅุญุตุงุฆูุงุช"
2. **ุงููุชูุฌุฉ ุงููุชููุนุฉ**: โ ุชุธูุฑ ุฅุญุตุงุฆูุงุช ุงูุฑุณุงุฆู ุจุดูู ุตุญูุญ

---

## ๐ ุงูุฃูุงู

### โ ุงูุชุดููุฑ
- API Key ูุชู ุชุดููุฑู ุจุงุณุชุฎุฏุงู base64 ูุจู ุงูุญูุธ
- ูุชู ูู ุงูุชุดููุฑ ุนูุฏ ุงูุงุณุชุฎุฏุงู ููุท

### โ RLS (Row Level Security)
- ููุนู ุนูู ุฌุฏูู `sms_logs`
- ููุนู ุนูู ุฌุฏูู `sms_api_settings`
- ููุท ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู ูููููู ุงููุตูู

### โ Policies
```sql
-- ุงููุฑุงุกุฉ: ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
"Authenticated users can read SMS logs"

-- ุงูุฅุฏุฑุงุฌ: ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
"Authenticated users can insert SMS logs"

-- ุงูุชุญุฏูุซ: ูููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
"Authenticated users can update SMS logs"
```

---

## ๐ ุงููุชุงุฆุฌ

### โ ุงููุดุงูู ุงููุญูููุฉ
1. โ ุฎุทุฃ "Could not find the 'message_text' column" - ุชู ุงูุฅุตูุงุญ
2. โ ุฎุทุฃ "Failed to fetch" ุนูุฏ ูุญุต ุงูุฑุตูุฏ - ุชู ุงูุฅุตูุงุญ
3. โ ูุนุงููุงุช API ุฎุงุทุฆุฉ - ุชู ุงูุชุตุญูุญ
4. โ ุนุฏู ุชุทุงุจู ุฃุณูุงุก ุงูุญููู - ุชู ุงูุฅุตูุงุญ

### โ ุงูุชุญุณููุงุช
1. โ schema cache ูุญุฏุซ
2. โ ุฌููุน ุงูููุงุฑุณ ููุดุฃุฉ
3. โ RLS policies ูุญุฏุซุฉ
4. โ ุงูููุฏ ูุชุทุงุจู ูุน ูุงุนุฏุฉ ุงูุจูุงูุงุช
5. โ API endpoints ุตุญูุญุฉ ุญุณุจ ุงููุซุงุฆู ุงูุฑุณููุฉ

### โ ุงูุงุฎุชุจุงุฑุงุช
1. โ ุงูุจูุงุก ููุฌุญ ุจุฏูู ุฃุฎุทุงุก
2. โ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฌุงูุฒุฉ
3. โ ุงูููุฏ ูุญุฏุซ ููุชุทุงุจู
4. โ ุฌุงูุฒ ููุงุฎุชุจุงุฑ ุงููุจุงุดุฑ

---

## ๐ ุงููููุงุช ุงููุนุฏูุฉ

1. โ `supabase/migrations/20251111233905_fix_sms_logs_schema_and_refresh.sql` - ุฌุฏูุฏ
2. โ `src/services/smsService.ts` - ูุนุฏู
3. โ `src/components/pages/SMSSettingsPage.tsx` - ูุนุฏู
4. โ `SMS_API_FIXES.md` - ุฏููู ุดุงูู
5. โ `SMS_FIXES_COMPLETED.md` - ูุฐุง ุงูููู

---

## ๐ ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู ูุธุงู TweetSMS API ุจูุฌุงุญ:

โ **ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุฌุฏูู `sms_logs` ูุญุฏุซ ูุฌููุน ุงูุฃุนูุฏุฉ ููุฌูุฏุฉ
โ **Schema Cache**: ุชู ุงูุชุญุฏูุซ
โ **API Endpoints**: ุตุญูุญุฉ ููุชุทุงุจูุฉ ูุน ุงููุซุงุฆู
โ **ูุนุงููุงุช API**: ุตุญูุญุฉ (to, sender, message)
โ **ุฃุณูุงุก ุงูุญููู**: ูุชุทุงุจูุฉ ุจูู ุงูููุฏ ููุงุนุฏุฉ ุงูุจูุงูุงุช
โ **ุงูุจูุงุก**: ูุงุฌุญ ุจุฏูู ุฃุฎุทุงุก
โ **ุงูุฃูุงู**: RLS ููุนู ูุขูู

**ุงููุธุงู ุฌุงูุฒ ููุงุณุชุฎุฏุงู ุงูุขู! ๐**

---

## ๐ ุงูุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุชุญูู ูู API Key ุงูุตุญูุญ
2. ุชุฃูุฏ ูู ุชูุนูู ุงูุฎุฏูุฉ (is_active = true)
3. ุฑุงุฌุน Developer Console ููุฃุฎุทุงุก (F12)
4. ุชุญูู ูู ูุฌูุฏ ุฑุตูุฏ ูุงูู

---

**ุชู ุจูุงุณุทุฉ**: Claude Code
**ุงูุชุงุฑูุฎ**: 11 ููููุจุฑ 2025
**ุงูุญุงูุฉ**: โ ููุชูู ููุฎุชุจุฑ
