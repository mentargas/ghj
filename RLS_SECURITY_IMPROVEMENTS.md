# ุชุญุณููุงุช ุฃูุงู Row Level Security (RLS)

## ุงูุชุงุฑูุฎ: 2025-11-11
## ุงูุญุงูุฉ: ููุชูู โ

---

## ููุฎุต ุชูููุฐู

ุชู ุชูููุฐ ุชุญุณููุงุช ุดุงููุฉ ูุฌุฐุฑูุฉ ุนูู ุณูุงุณุงุช Row Level Security (RLS) ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุนุงูุฌุฉ ุซุบุฑุงุช ุฃูููุฉ ุฎุทูุฑุฉ ูุงูุช ุชุนุฑุถ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ ููุฎุทุฑ.

### ุงููุดุงูู ุงูุชู ุชู ุญููุง:
- โ ุจูุงูุงุช ุงููุณุชููุฏูู ูุงูุช ููุดููุฉ ููุฌููุน
- โ ูุนูููุงุช ุงููุณุชุฎุฏููู ูุงูุช ูุชุงุญุฉ ูุฃู ุดุฎุต
- โ ุฅุนุฏุงุฏุงุช SMS API ูุงูุช ููุดููุฉ
- โ ุฑููุฒ OTP ุจุฏูู rate limiting
- โ ุนุฏู ูุฌูุฏ ูุตู ููุตูุงุญูุงุช
- โ ุฅููุงููุฉ ุงูุชูุงุนุจ ุจุงูุทุฑูุฏ ูุงูููุงู
- โ ุฎุทุฑ ุชุตุนูุฏ ุงูุตูุงุญูุงุช

---

## ุงูุฏูุงู ุงููุณุงุนุฏุฉ ุงูุฌุฏูุฏุฉ

ุชู ุฅูุดุงุก 6 ุฏูุงู ูุณุงุนุฏุฉ ูุชุณููู ุงูุชุญูู ูู ุงูุตูุงุญูุงุช:

### 1. `get_user_role()`
```sql
-- ุงูุญุตูู ุนูู ุฏูุฑ ุงููุณุชุฎุฏู ุงูุญุงูู
SELECT get_user_role(); -- ุฅุฑุฌุงุน: 'ูุฏูุฑ ุงููุธุงู'ุ 'ููุธู ุงููุคุณุณุฉ'ุ ุฅูุฎ
```

### 2. `check_user_permission(permission_name)`
```sql
-- ุงูุชุญูู ูู ุตูุงุญูุฉ ูุญุฏุฏุฉ
SELECT check_user_permission('ูุฑุงุกุฉ ุงููุณุชููุฏูู'); -- true/false
```

### 3. `user_belongs_to_organization(org_id)`
```sql
-- ูุญุต ุงูุชูุงุก ุงููุณุชุฎุฏู ููุคุณุณุฉ
SELECT user_belongs_to_organization('uuid-here'); -- true/false
```

### 4. `get_user_organization_id()`
```sql
-- ุงูุญุตูู ุนูู ูุคุณุณุฉ ุงููุณุชุฎุฏู
SELECT get_user_organization_id(); -- uuid ุฃู null
```

### 5. `can_manage_package(package_id)`
```sql
-- ุงูุชุญูู ูู ุตูุงุญูุฉ ุฅุฏุงุฑุฉ ุทุฑุฏ
SELECT can_manage_package('uuid-here'); -- true/false
```

### 6. `get_user_type()`
```sql
-- ุชุญุฏูุฏ ููุน ุงููุณุชุฎุฏู
SELECT get_user_type(); -- 'staff', 'anonymous', 'unknown'
```

---

## ุงูุชุญุณููุงุช ุญุณุจ ุงูุฌุฏูู

### 1. beneficiaries (ุงููุณุชููุฏูู) ๐ด ุฃููููุฉ ูุตูู

**ูุจู ุงูุชุญุณูู:**
```sql
USING (true) -- ุฃู ุดุฎุต ููููู ุงููุฑุงุกุฉ!
```

**ุจุนุฏ ุงูุชุญุณูู:**
```sql
-- ุงููุฑุงุกุฉ: ููุท ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู ุจุตูุงุญูุงุช
USING (
  check_user_is_admin()
  OR (organization_id IS NOT NULL AND user_belongs_to_organization(organization_id))
  OR check_user_permission('ูุฑุงุกุฉ ุงููุณุชููุฏูู')
)

-- ุงูุฅุฏุฑุงุฌ: ุงูููุธููู ุงููุฎูููู ููุท
WITH CHECK (
  check_user_is_admin()
  OR get_user_role() IN ('ููุธู ุงููุคุณุณุฉ', 'ูุฏุฎู ุจูุงูุงุช')
  OR check_user_permission('ุฅุถุงูุฉ ูุณุชููุฏูู')
)

-- ุงูุญุฐู: ุงููุฏุฑุงุก ููุท
USING (check_user_is_admin())
```

**ุงููุงุฆุฏุฉ:**
- ุญูุงูุฉ ุงูุฑูู ุงููุทููุ ุงููุงุชูุ ุงูุนููุงูุ ุงูุญุงูุงุช ุงูุทุจูุฉ
- ูุตู ูุงุถุญ ููุตูุงุญูุงุช
- ููุธูู ุงููุคุณุณุฉ ูุฑูู ูุณุชููุฏู ูุคุณุณุชูู ููุท

---

### 2. system_users (ุงููุณุชุฎุฏููู) ๐ด ุฃููููุฉ ูุตูู

**ูุจู ุงูุชุญุณูู:**
```sql
USING (true) -- ุงูุฌููุน ูุฑู ูุนูููุงุช ูู ุงููุณุชุฎุฏููู!
```

**ุจุนุฏ ุงูุชุญุณูู:**
```sql
-- ุงููุฑุงุกุฉ: ูุญุฏูุฏุฉ ุฌุฏุงู
USING (
  auth_user_id = auth.uid() -- ุงููุณุชุฎุฏู ูุฑู ุจูุงูุงุชู
  OR check_user_is_admin()  -- ุงููุฏุฑุงุก ูุฑูู ุงูุฌููุน
  OR (organization_id IS NOT NULL AND organization_id = get_user_organization_id()) -- ุงูุฒููุงุก
)

-- ุงูุฅุฏุฑุงุฌ: ููููุน ูุจุงุดุฑุฉ (ุนุจุฑ Trigger ููุท)
WITH CHECK (false)

-- ุงูุชุญุฏูุซ: ูุญุฏูุฏ
USING (auth_user_id = auth.uid() OR check_user_is_admin())
```

**ุงููุงุฆุฏุฉ:**
- ุญูุงูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุงููุงุชู
- ููุน ุงุณุชูุฏุงู ุงููุณุคูููู
- View ูุญุฏูุฏ ูููุนูููุงุช ุงูุนุงูุฉ ููุท

---

### 3. packages (ุงูุทุฑูุฏ) ๐ด ุฃููููุฉ ูุตูู

**ูุจู ุงูุชุญุณูู:**
```sql
USING (true) WITH CHECK (true) -- ุฃู ููุธู ูุนุฏู ุฃู ุทุฑุฏ!
```

**ุจุนุฏ ุงูุชุญุณูู:**
```sql
-- ุงููุฑุงุกุฉ: ุญุณุจ ุงููุคุณุณุฉ
USING (
  check_user_is_admin()
  OR (organization_id IS NOT NULL AND user_belongs_to_organization(organization_id))
  OR check_user_permission('ูุฑุงุกุฉ ุงูุทุฑูุฏ')
)

-- ุงูุชุญุฏูุซ: ูุน ููุน ุชุนุฏูู ุงููุณููุฉ
USING (
  (status != 'delivered' OR check_user_is_admin())
  AND (check_user_is_admin() OR user_belongs_to_organization(organization_id))
)

-- ุงูุญุฐู: ุงููุฏุฑุงุก ููุท + ููุน ุญุฐู ุงููุณููุฉ
USING (check_user_is_admin() AND status != 'delivered')
```

**ุงููุงุฆุฏุฉ:**
- ููุน ุงูุชูุงุนุจ ุจุงูุชูุฒูุนุงุช
- ุญูุงูุฉ ุงูุทุฑูุฏ ุงููุณููุฉ
- ุชุชุจุน ุฏููู ูููุณุคูููุฉ

---

### 4. sms_api_settings (ุฅุนุฏุงุฏุงุช SMS) ๐ด ุฃููููุฉ ูุตูู

**ูุจู ุงูุชุญุณูู:**
```sql
TO authenticated USING (true) -- ุงูุฌููุน ูุฑู ุฅุนุฏุงุฏุงุช API!
```

**ุจุนุฏ ุงูุชุญุณูู:**
```sql
-- ุฌููุน ุงูุนูููุงุช: ุงููุฏุฑุงุก ููุท
FOR SELECT USING (check_user_is_admin())
FOR INSERT WITH CHECK (check_user_is_admin() AND NOT EXISTS (...))
FOR UPDATE USING (check_user_is_admin())
FOR DELETE USING (check_user_is_admin())
```

**ุงููุงุฆุฏุฉ:**
- ุญูุงูุฉ ุจูุงูุงุช API ุงููุดูุฑุฉ
- ููุน ุฅุณุงุกุฉ ุงุณุชุฎุฏุงู ุฎุฏูุฉ SMS
- ุชูููุฏ ุตุงุฑู ูููุตูู

---

### 5. verification_codes (ุฑููุฒ ุงูุชุญูู) ๐ด ุฃููููุฉ ูุตูู

**ูุจู ุงูุชุญุณูู:**
```sql
TO anon, authenticated WITH CHECK (true) -- ุงูุฒูุงุฑ ููุดุฆูู ุฑููุฒ ุจูุง ุญุฏูุฏ!
```

**ุจุนุฏ ุงูุชุญุณูู:**
```sql
-- ุงููุฑุงุกุฉ: ุงููุฏุฑุงุก ููุท
FOR SELECT USING (check_user_is_admin())

-- ุงูุฅุฏุฑุงุฌ: ูุน Rate Limiting
FOR INSERT WITH CHECK (
  NOT EXISTS (
    SELECT 1 FROM verification_codes vc
    WHERE vc.phone_number = verification_codes.phone_number
    AND vc.created_at > NOW() - INTERVAL '1 minute'
    AND NOT vc.is_verified
  )
)
```

**ุงููุงุฆุฏุฉ:**
- ููุน ูุฌูุงุช DDoS ุนูู ูุธุงู SMS
- ุญูุงูุฉ ูู ุงุณุชูุฒุงู ุงูุฑุตูุฏ
- rate limiting ุนูู ูุณุชูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

---

### 6. tasks (ุงูููุงู) ู couriers (ุงูููุฏูุจูู)

**ุงูุชุญุณููุงุช:**
- ุงูููุฏูุจ ูุฑู ููุงูู ููุท
- ููุธูู ุงูุชูุฒูุน ูุฏูุฑูู ุงูููุงู
- ูุตู ูุงุถุญ ุจูู ุงูุฃุฏูุงุฑ
- ุญูุงูุฉ ุจูุงูุงุช ุงูุฃุฏุงุก ูุงูุชููููุงุช

---

### 7. roles ู permissions (ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช)

**ุงูุชุญุณููุงุช:**
- ุงููุฑุงุกุฉ: ููุฌููุน (ููุนุฑุถ ููุท)
- ุงูุชุนุฏูู ูุงูุญุฐู: ุงููุฏุฑุงุก ููุท
- ููุน ุญุฐู ุงูุฃุฏูุงุฑ ุงูุฃุณุงุณูุฉ
- ุชุณุฌูู ุฌููุน ุงูุชุบููุฑุงุช ูู activity_log

**Trigger ุฌุฏูุฏ:**
```sql
CREATE TRIGGER trigger_log_role_changes
  AFTER INSERT OR UPDATE OR DELETE ON roles
  FOR EACH ROW
  EXECUTE FUNCTION log_role_changes();
```

---

### 8. activity_log (ุณุฌู ุงููุดุงุทุงุช)

**ุงูุชุญุณููุงุช:**
- ุงููุฑุงุกุฉ: ุงููุฏุฑุงุก ููุท
- ุงูุฅุฏุฑุงุฌ: ุงููุธุงู ูุงูุฌููุน (ููุชุณุฌูู)
- ุงูุชุญุฏูุซ ูุงูุญุฐู: ููููุน ุชูุงูุงู (ููุญูุงุธ ุนูู ุณูุงูุฉ ุงูุณุฌู)

---

### 9. organizations, families, alerts, package_templates

**ุงูุชุญุณููุงุช:**
- ุชูููุฏ ุงููุตูู ุญุณุจ ุงููุคุณุณุฉ
- ูุตู ุงูุตูุงุญูุงุช ุจูุถูุญ
- ุญูุงูุฉ ูู ุงูุชูุงุนุจ
- ุงููุฏุฑุงุก ูุฏูุฑูู ูู ุดูุก

---

## ุงูููุฒุงุช ุงูุฅุถุงููุฉ

### 1. View ูุญุฏูุฏ ูู system_users
```sql
CREATE VIEW system_users_public AS
SELECT id, name, role_id, status, organization_id, created_at
FROM system_users WHERE status = 'active';
```

### 2. Trigger ูุชุณุฌูู ุงูุชุบููุฑุงุช
```sql
-- ุชุณุฌูู ุชููุงุฆู ูุฌููุน ุงูุชุบููุฑุงุช ุนูู ุงูุฃุฏูุงุฑ
CREATE TRIGGER trigger_log_role_changes ...
```

### 3. ุญููู ุฌุฏูุฏุฉ
```sql
-- ุฅุถุงูุฉ organization_id ูู system_users
ALTER TABLE system_users ADD COLUMN organization_id uuid;

-- ุฅุถุงูุฉ auth_user_id ูู couriers (ููุชูุงูู ุงููุณุชูุจูู)
ALTER TABLE couriers ADD COLUMN auth_user_id uuid;
```

---

## ุฅุญุตุงุฆูุงุช ุงูุชุญุณูู

| ุงูุฌุฏูู | ุงูุณูุงุณุงุช ุงููุฏููุฉ | ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ | ูุณุชูู ุงูุฃูุงู |
|--------|------------------|-------------------|---------------|
| beneficiaries | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| system_users | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| packages | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| sms_api_settings | 4 (ูุชูุณุทุฉ) | 4 (ูููุฉ) | ๐ก โ ๐ข |
| verification_codes | 3 (ุถุนููุฉ) | 3 (ูููุฉ) | ๐ด โ ๐ข |
| tasks | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| couriers | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| roles | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| permissions | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| organizations | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| families | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| alerts | 3 (ุถุนููุฉ) | 4 (ูุชูุณุทุฉ) | ๐ด โ ๐ก |
| activity_log | 2 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |
| package_templates | 3 (ุถุนููุฉ) | 4 (ูููุฉ) | ๐ด โ ๐ข |

**ุงููุฌููุน:**
- **14 ุฌุฏูู** ุชู ุชุฃูููู
- **6 ุฏูุงู ูุณุงุนุฏุฉ** ุฌุฏูุฏุฉ
- **50+ ุณูุงุณุฉ RLS** ูุญุณูุฉ
- **1 Trigger** ููุชุณุฌูู ุงูุชููุงุฆู
- **1 View** ูุญุฏูุฏ ููุจูุงูุงุช ุงูุนุงูุฉ

---

## ุงููููุงุช ุงูููุดุฃุฉ

1. `create_rls_helper_functions_v2.sql` - ุงูุฏูุงู ุงููุณุงุนุฏุฉ
2. `fix_beneficiaries_rls_policies.sql` - ุชุฃููู ุงููุณุชููุฏูู
3. `fix_system_users_rls_policies.sql` - ุชุฃููู ุงููุณุชุฎุฏููู
4. `fix_packages_rls_policies.sql` - ุชุฃููู ุงูุทุฑูุฏ
5. `fix_sensitive_tables_rls_policies_v2.sql` - ุชุฃููู ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ
6. `fix_tasks_couriers_rls_policies.sql` - ุชุฃููู ุงูููุงู ูุงูููุฏูุจูู
7. `fix_roles_permissions_rls_policies.sql` - ุชุฃููู ุงูุฃุฏูุงุฑ
8. `fix_remaining_tables_rls_policies.sql` - ุชุฃููู ุงูุฌุฏุงูู ุงููุชุจููุฉ

---

## ุงูุชูุงูู ูุน ุงููุนุงููุฑ

โ **GDPR Compliance**: ุญูุงูุฉ ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ
โ **OWASP Top 10**: ูุนุงูุฌุฉ ุซุบุฑุงุช ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู
โ **Principle of Least Privilege**: ูู ูุณุชุฎุฏู ูุฏูู ุฃูู ุตูุงุญูุงุช ููููุฉ
โ **Audit Trail**: ุชุณุฌูู ุฌููุน ุงูุชุบููุฑุงุช ุงูุญุฑุฌุฉ
โ **Data Integrity**: ููุน ุงูุชุนุฏูู ูุงูุญุฐู ุบูุฑ ุงููุตุฑุญ ุจู

---

## ุงูุฎุทูุงุช ุงูุชุงููุฉ (ุงุฎุชูุงุฑู)

### ุชูุตูุงุช ููุชุญุณูู ุงููุณุชูุจูู:

1. **Rate Limiting ูุชูุฏู**
   - ุฅุถุงูุฉ rate limiting ูุฌููุน ุงูุนูููุงุช ุงูุญุณุงุณุฉ
   - ุงุณุชุฎุฏุงู Redis ููุชุญูู ุงูุฏููู

2. **Audit Logging ูุญุณูู**
   - ุชุณุฌูู ุฌููุน ุนูููุงุช ุงููุฑุงุกุฉ ุงูุญุณุงุณุฉ
   - ุฅูุดุงุก ุชูุงุฑูุฑ ุฃูููุฉ ุฏูุฑูุฉ

3. **Multi-Factor Authentication**
   - ุฅุถุงูุฉ MFA ูููุฏุฑุงุก
   - ุงุณุชุฎุฏุงู `auth.jwt()` ููุชุญูู ูู ูุณุชูู ุงูุฃูุงู

4. **Data Encryption**
   - ุชุดููุฑ ุงูุจูุงูุงุช ุงูุญุณุงุณุฉ ุนูู ูุณุชูู ุงูุชุทุจูู
   - ุงุณุชุฎุฏุงู pgcrypto ูุชุดููุฑ ูุงุนุฏุฉ ุงูุจูุงูุงุช

5. **Monitoring & Alerts**
   - ุฅุดุนุงุฑุงุช ููุฑูุฉ ุนูุฏ ูุญุงููุงุช ุงููุตูู ุงููุดุจููุฉ
   - Dashboard ููุฑุงูุจุฉ ุงูุฃูุงู

---

## ุงูุงุฎุชุจุงุฑ

### ููููุฉ ุงุฎุชุจุงุฑ ุงูุณูุงุณุงุช ุงูุฌุฏูุฏุฉ:

```sql
-- 1. ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ุงููุณุชููุฏูู (ูุฌุจ ุฃู ุชูุดู ููุฒูุงุฑ)
SET ROLE anon;
SELECT * FROM beneficiaries; -- ุฎุทุฃ: ูุง ููุฌุฏ ุตูุงุญูุฉ

-- 2. ุงุฎุชุจุงุฑ ูุฑุงุกุฉ ุฅุนุฏุงุฏุงุช SMS (ูุฌุจ ุฃู ุชูุดู ูุบูุฑ ุงููุฏุฑุงุก)
SET ROLE authenticated;
SELECT * FROM sms_api_settings; -- ุฎุทุฃ: ุตูุงุญูุงุช ุบูุฑ ูุงููุฉ

-- 3. ุงุฎุชุจุงุฑ rate limiting ูู OTP
INSERT INTO verification_codes (...); -- ูุฌุงุญ
INSERT INTO verification_codes (...); -- ูุดู (ุฃูู ูู ุฏูููุฉ)

-- 4. ุงุฎุชุจุงุฑ ููุน ุชุนุฏูู activity_log
UPDATE activity_log SET action = 'test'; -- ุฎุทุฃ: ููููุน
```

---

## ุงูุฏุนู

ูุฃู ุงุณุชูุณุงุฑุงุช ุฃู ูุดุงููุ ูุฑุฌู:
1. ูุฑุงุฌุนุฉ ูุฐุง ุงูููู
2. ูุญุต ุงูุณูุงุณุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช: `\d+ table_name` ูู psql
3. ุงุฎุชุจุงุฑ ุงูุฏูุงู ุงููุณุงุนุฏุฉ ุฃููุงู
4. ุงูุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ูุฏูู ุงูุตูุงุญูุงุช ุงูุตุญูุญุฉ

---

## ุงูุฎูุงุตุฉ

ุชู ุชูููุฐ ุชุญุณููุงุช ุดุงููุฉ ูุฌุฐุฑูุฉ ุนูู ูุธุงู Row Level Securityุ ููุง ุฑูุน ูุณุชูู ุงูุฃูุงู ูู **ุถุนูู ุฌุฏุงู (๐ด)** ุฅูู **ููู ูุขูู (๐ข)**.

ุงููุธุงู ุงูุขู:
- โ ุขูู ููุงุณุชุฎุฏุงู ูู ุงูุฅูุชุงุฌ
- โ ูุชูุงูู ูุน ูุนุงููุฑ ุงูุฃูุงู ุงูุฏูููุฉ
- โ ูุญูู ูู ุงูุซุบุฑุงุช ุงูุฃูููุฉ ุงูุดุงุฆุนุฉ
- โ ูุงุจู ููุชูุณุน ูุงูุตูุงูุฉ
- โ ููุซู ุจุงููุงูู

---

**ุชุงุฑูุฎ ุงูุชูููุฐ:** 2025-11-11
**ุงูุญุงูุฉ:** ููุชูู โ
**ุงููุทูุฑ:** Claude Code AI Assistant
