# ูุธุงู ุงููุตุงุฏูุฉ ุงูุญูููู - ุฏููู ุงูุงุณุชุฎุฏุงู

## ูุธุฑุฉ ุนุงูุฉ

ุชู ุชุญููู ุงููุธุงู ูู ูุตุงุฏูุฉ ููููุฉ (Mock Authentication) ุฅูู ูุธุงู ูุตุงุฏูุฉ ุงุญุชุฑุงูู ุญูููู ุจุงุณุชุฎุฏุงู **Supabase Auth**. ูุฐุง ุงูุชุญุฏูุซ ูููุฑ ุฃูุงูุงู ุฃูุถู ูุชุฌุฑุจุฉ ูุณุชุฎุฏู ุงุญุชุฑุงููุฉ.

---

## ๐ฏ ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ

### 1. ุฅุฒุงูุฉ ุงููุธุงู ุงููููู
- โ ุชู ุญุฐู `MockLogin.tsx`
- โ ุชู ุญุฐู ุฌููุน ุงููุณุชุฎุฏููู ุงููููููู ูู `mockData.ts`
- โ ุชู ุฅุฒุงูุฉ ุฌููุน ุงูุญุณุงุจุงุช ุงูุชุฌุฑูุจูุฉ

### 2. ุฅุถุงูุฉ ูุธุงู ูุตุงุฏูุฉ ุญูููู
- โ ูููู ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ: `RealLogin.tsx`
- โ ุฑุจุท `auth.users` ูุน `system_users` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
- โ Trigger ุชููุงุฆู ูุฅูุดุงุก ุณุฌู ูู `system_users` ุนูุฏ ุงูุชุณุฌูู
- โ ุฅุฏุงุฑุฉ ุงูุฌูุณุงุช ุชููุงุฆูุงู ุจุงุณุชุฎุฏุงู `supabase.auth`

### 3. ุชุญุฏูุซ AuthContext
- โ ุงูุชุญูู ุงูุชููุงุฆู ูู ุงูุฌูุณุฉ ุนูุฏ ุจุฏุก ุงูุชุทุจูู
- โ ุงูุงุณุชูุงุน ูุชุบููุฑุงุช ุญุงูุฉ ุงููุตุงุฏูุฉ
- โ ุชุณุฌูู ุฎุฑูุฌ ุญูููู ูุญุฐู ุงูุฌูุณุฉ ูู Supabase

---

## ๐ ุงูุจุฏุก - ุฅูุดุงุก ุฃูู ุญุณุงุจ ุฅุฏุงุฑู

### ุงูุทุฑููุฉ 1: ุนุจุฑ ูุงุฌูุฉ ุงูุชุณุฌูู

1. ุงูุชุญ ุงูุชุทุจูู ูู ุงููุชุตูุญ
2. ูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎููุ ุงุถุบุท ุนูู "ุฅูุดุงุก ุญุณุงุจ ุฌุฏูุฏ"
3. ุฃุฏุฎู ุงูุจูุงูุงุช ุงูุชุงููุฉ:
   - **ุงูุงุณู ุงููุงูู**: ุฃุญูุฏ ูุญูุฏ (ูุซุงู)
   - **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู**: admin@example.com
   - **ุฑูู ุงููุงุชู**: 0599123456 (ุงุฎุชูุงุฑู)
   - **ูููุฉ ุงููุฑูุฑ**: ูุฌุจ ุฃู ุชููู 6 ุฃุญุฑู ุนูู ุงูุฃูู
4. ุงุถุบุท "ุฅูุดุงุก ุงูุญุณุงุจ"
5. ุณูุชู ุฅูุดุงุก ุญุณุงุจู ุชููุงุฆูุงู ูุชุณุฌูู ุฏุฎููู

### ุงูุทุฑููุฉ 2: ุนุจุฑ Supabase Dashboard

1. ุงูุชุญ [Supabase Dashboard](https://app.supabase.com)
2. ุงุฐูุจ ุฅูู **Authentication** โ **Users**
3. ุงุถุบุท **Add user** โ **Create new user**
4. ุฃุฏุฎู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุฉ ุงููุฑูุฑ
5. ุงุถุบุท **Create user**
6. ุณูุชู ุฅูุดุงุก ุณุฌู ุชููุงุฆูุงู ูู ุฌุฏูู `system_users` ุจุฏูุฑ "ูุฏูุฑ ุงููุธุงู"

---

## ๐ ุชุณุฌูู ุงูุฏุฎูู

### ุงููุนูููุงุช ุงููุทููุจุฉ
- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
- ูููุฉ ุงููุฑูุฑ

### ุฎุทูุงุช ุชุณุฌูู ุงูุฏุฎูู
1. ุฃุฏุฎู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
2. ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ
3. ุงุถุบุท "ุชุณุฌูู ุงูุฏุฎูู"
4. ุณูุชู ุงูุชุญูู ูู ุจูุงูุงุชู
5. ุฅุฐุง ูุงูุช ุตุญูุญุฉุ ุณุชุชู ุฅุนุงุฏุฉ ุชูุฌููู ูููุญุฉ ุงูุชุญูู

---

## ๐ ุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ

ุฅุฐุง ูุณูุช ูููุฉ ุงููุฑูุฑ:

1. ูู ุตูุญุฉ ุชุณุฌูู ุงูุฏุฎููุ ุงุถุบุท "ูุณูุช ูููุฉ ุงููุฑูุฑุ"
2. ุฃุฏุฎู ุจุฑูุฏู ุงูุฅููุชุฑููู
3. ุงุถุบุท "ุฅุฑุณุงู ุฑุงุจุท ุฅุนุงุฏุฉ ุงูุชุนููู"
4. ุชุญูู ูู ุจุฑูุฏู ุงูุฅููุชุฑููู
5. ุงุถุบุท ุนูู ุงูุฑุงุจุท ุงููุฑุณู
6. ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ
7. ุงุถุบุท "ุญูุธ"

---

## ๐ ุจููุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `system_users`

```sql
CREATE TABLE system_users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  auth_user_id uuid UNIQUE REFERENCES auth.users(id), -- ุฑุจุท ูุน Supabase Auth
  name text NOT NULL,
  email text NOT NULL UNIQUE,
  phone text,
  role_id uuid NOT NULL REFERENCES roles(id),
  associated_id uuid,
  associated_type text,
  status text DEFAULT 'active',
  last_login timestamptz,
  created_at timestamptz DEFAULT now()
);
```

### ุงูุนูุงูุฉ ุจูู ุงูุฌุฏุงูู

```
auth.users (Supabase Auth)
    โ (auth_user_id)
system_users
    โ (role_id)
roles
```

---

## ๐ ุณูุงุณุงุช ุงูุฃูุงู (RLS)

### ูููุณุชุฎุฏููู ุงูุฅุฏุงุฑููู

```sql
-- ูุฑุงุกุฉ: ุฌููุน ุงููุณุชุฎุฏููู ุงููุตุงุฏู ุนูููู
CREATE POLICY "Authenticated users can read all system users"
  ON system_users FOR SELECT TO authenticated
  USING (true);

-- ุชุญุฏูุซ: ุงููุณุชุฎุฏู ููููู ุชุญุฏูุซ ูุนูููุงุชู ููุท
CREATE POLICY "Users can update own info"
  ON system_users FOR UPDATE TO authenticated
  USING (auth_user_id = auth.uid())
  WITH CHECK (auth_user_id = auth.uid());

-- ุญุฐู: ุงููุฏุฑุงุก ููุท
CREATE POLICY "Only admins can delete users"
  ON system_users FOR DELETE TO authenticated
  USING (check_user_is_admin());
```

### ููุฌุฏุงูู ุงูุฃุฎุฑู

ุชู ุชุญุฏูุซ ุฌููุน ุณูุงุณุงุช RLS ูู ุงูุฌุฏุงูู ุงูุญุณุงุณุฉ ูุชุชุทูุจ `authenticated` role ุจุฏูุงู ูู `anon`:

- `sms_logs`
- `sms_api_settings`
- `verification_codes`
- `beneficiaries`
- `packages`
- ูุบูุฑูุง...

---

## ๐๏ธ ุงูุฏูุงู ุงููุณุงุนุฏุฉ

### `get_current_user_info()`
ุชุญุตู ุนูู ูุนูููุงุช ุงููุณุชุฎุฏู ุงูุญุงูู ุงููุตุงุฏู:

```typescript
const { data, error } = await supabase.rpc('get_current_user_info');
if (data?.success) {
  console.log('User:', data.user);
  console.log('Role:', data.role);
}
```

### `check_user_is_admin()`
ุชุชุญูู ูู ุฃู ุงููุณุชุฎุฏู ุงูุญุงูู ุฅุฏุงุฑู:

```typescript
const { data, error } = await supabase.rpc('check_user_is_admin');
if (data === true) {
  // ุงููุณุชุฎุฏู ุฅุฏุงุฑู
}
```

---

## ๐ง Trigger ุงูุชููุงุฆู

ุนูุฏ ุฅูุดุงุก ูุณุชุฎุฏู ุฌุฏูุฏ ูู `auth.users`ุ ูุชู ุชููุงุฆูุงู:

1. ุงุณุชุฎุฑุงุฌ ุงูุงุณู ูู `raw_user_meta_data` ุฃู ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
2. ุงูุญุตูู ุนูู `role_id` ูุฏูุฑ "ูุฏูุฑ ุงููุธุงู"
3. ุฅูุดุงุก ุณุฌู ูู `system_users` ูุน:
   - `auth_user_id` = ูุนุฑู ุงููุณุชุฎุฏู ูู auth.users
   - `name` = ุงูุงุณู ุงููุณุชุฎุฑุฌ
   - `email` = ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
   - `phone` = ุฑูู ุงููุงุชู (ุฅู ูุฌุฏ)
   - `role_id` = ูุนุฑู ุฏูุฑ ุงููุฏูุฑ
   - `status` = 'active'

---

## ๐ฑ ุงุณุชุฎุฏุงู ูู ุงูููุฏ

### ุชุณุฌูู ุงูุฏุฎูู

```typescript
import { supabase } from './lib/supabaseClient';

const { data, error } = await supabase.auth.signInWithPassword({
  email: 'admin@example.com',
  password: 'password123',
});

if (error) {
  console.error('Login failed:', error.message);
} else {
  console.log('Logged in:', data.user);
}
```

### ุงูุชุณุฌูู

```typescript
const { data, error } = await supabase.auth.signUp({
  email: 'newadmin@example.com',
  password: 'password123',
  options: {
    data: {
      name: 'ุฃุญูุฏ ูุญูุฏ',
      phone: '0599123456',
    },
  },
});
```

### ุชุณุฌูู ุงูุฎุฑูุฌ

```typescript
const { error } = await supabase.auth.signOut();
```

### ุงูุญุตูู ุนูู ุงูุฌูุณุฉ ุงูุญุงููุฉ

```typescript
const { data: { session }, error } = await supabase.auth.getSession();
if (session) {
  console.log('User logged in:', session.user);
}
```

---

## โ๏ธ ููุงุญุธุงุช ูููุฉ

### 1. ุชุฃููุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
ุจุดูู ุงูุชุฑุงุถูุ Supabase Auth ูุชุทูุจ ุชุฃููุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู. ูููู ุชุนุทููู ูู:
- Supabase Dashboard โ Authentication โ Settings
- ุฃุฒู ุงูุนูุงูุฉ ูู "Enable email confirmations"

### 2. ุงูุฃูุงู
- ูุง ุชุดุงุฑู ููุงุชูุญ API ุงูุฎุงุตุฉ ุจู
- ุงุณุชุฎุฏู ูููุงุช ูุฑูุฑ ูููุฉ (8+ ุฃุญุฑูุ ุฃุญุฑู ูุจูุฑุฉ ูุตุบูุฑุฉุ ุฃุฑูุงูุ ุฑููุฒ)
- ูุนูู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ (2FA) ูู Supabase Dashboard

### 3. ุงูุฃุฏูุงุฑ ูุงูุตูุงุญูุงุช
- ุญุงููุงูุ ุฌููุน ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ ูุญุตููู ุนูู ุฏูุฑ "ูุฏูุฑ ุงููุธุงู" ุชููุงุฆูุงู
- ูููู ุชุบููุฑ ุงูุฏูุฑ ูู ููุญุฉ ุงูุชุญูู ุฃู ุนุจุฑ SQL ูุจุงุดุฑุฉ

### 4. ุงููุณุชููุฏูู (Beneficiaries)
- ุงููุณุชููุฏูู **ููุณูุง** ูุณุชุฎุฏููู ูู `auth.users`
- ูุตููู ููุจูุงุจุฉ ุนุจุฑ OTP ููุท
- ุจูุงูุงุชูู ูู ุฌุฏูู `beneficiaries` ููุท

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฎุทุฃ: "Invalid login credentials"
- ุชุญูู ูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุฉ ุงููุฑูุฑ
- ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ููุฌูุฏ ูู `auth.users`

### ุฎุทุฃ: "Email not confirmed"
- ุชุญูู ูู ุจุฑูุฏู ุงูุฅููุชุฑููู
- ุฃู ุนุทูู ุชุฃููุฏ ุงูุจุฑูุฏ ูู Supabase Dashboard

### ุฎุทุฃ: "ูู ูุชู ุงูุนุซูุฑ ุนูู ูุนูููุงุช ุงููุณุชุฎุฏู"
- ุชุฃูุฏ ูู ูุฌูุฏ ุณุฌู ูู `system_users` ูุน `auth_user_id` ุตุญูุญ
- ุชุญูู ูู ุฃู Trigger ูุนูู ุจุดูู ุตุญูุญ

### ุฎุทุฃ: "Row Level Security policy"
- ุชุฃูุฏ ูู ุฃูู ูุณุฌู ุฏุฎูู (`authenticated`)
- ุชุญูู ูู ุณูุงุณุงุช RLS ูู ุงูุฌุฏูู ุงููุทููุจ

---

## ๐ ุงููุณุงุนุฏุฉ

ุฅุฐุง ูุงุฌูุช ุฃู ูุดููุฉ:
1. ุชุญูู ูู console ุงููุชุตูุญ (F12)
2. ุฑุงุฌุน ุณุฌูุงุช Supabase Dashboard โ Logs
3. ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ุงูุจูุฆุฉ (`.env`)
4. ุฑุงุฌุน ูุฐุง ุงูุฏููู ูุฑุฉ ุฃุฎุฑู

---

## โ ุงูุฎูุงุตุฉ

ูุธุงู ุงููุตุงุฏูุฉ ุงูุขู:
- โ ุงุญุชุฑุงูู ูุขูู
- โ ูุณุชุฎุฏู Supabase Auth
- โ ูุง ููุฌุฏ ุจูุงูุงุช ููููุฉ
- โ ูุฏุนู ุชุณุฌูู ุงูุฏุฎููุ ุงูุชุณุฌููุ ูุงุณุชุนุงุฏุฉ ูููุฉ ุงููุฑูุฑ
- โ ูุฏูุฑ ุงูุฌูุณุงุช ุชููุงุฆูุงู
- โ ูุฑุจุท auth.users ูุน system_users ุจุดูู ุชููุงุฆู

**ููุงุญุธุฉ**: ูุฐุง ุงููุธุงู ูุฎุตุต ูููุณุคูููู ุงูุฅุฏุงุฑููู ููุท. ุงููุณุชููุฏูู ูุณุชุฎุฏููู ูุธุงู OTP ูููุตู ุนุจุฑ ุงูุจูุงุจุฉ ุงูุฎุงุตุฉ ุจูู.
