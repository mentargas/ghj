# تحسينات بوابة المستفيدين - نظام شامل لإدارة الحسابات والبيانات

## نظرة عامة

تم تطوير نظام شامل لبوابة المستفيدين يتيح للمستفيدين:
- التسجيل لأول مرة مع إنشاء كلمة مرور
- تسجيل الدخول بكلمة المرور
- عرض حالة التوثيق والأهلية للحساب
- مشاهدة المؤسسات المقترحة بناءً على الموقع والاحتياج
- عرض جميع الطرود (المستلمة، قيد التوصيل، القادمة)
- تحديث البيانات الشخصية مع مراجعة من الإدارة
- متابعة حالة طلبات التحديث

## التغييرات الرئيسية

### 1. تحديثات قاعدة البيانات

#### جدول beneficiaries - حقول جديدة:
- `verification_status`: حالة التوثيق (verified, under_review, rejected)
- `qualification_status`: حالة الأهلية (qualified, needs_update, unqualified)
- `verification_notes`: ملاحظات التوثيق
- `qualification_notes`: ملاحظات الأهلية
- `suggested_organizations_ids`: مصفوفة معرفات المؤسسات المقترحة
- `password_created_at`: تاريخ إنشاء كلمة المرور

#### جدول packages - حقول جديدة:
- `tracking_number`: رقم تتبع فريد للطرد
- `scheduled_delivery_date`: تاريخ التسليم المتوقع

#### جدول beneficiary_data_updates - جديد:
جدول لتتبع جميع طلبات تحديث البيانات من المستفيدين:
- `beneficiary_id`: معرف المستفيد
- `update_type`: نوع التحديث
- `changes`: كائن JSON يحتوي على التغييرات المطلوبة
- `status`: حالة الطلب (pending, approved, rejected)
- `requested_at`: تاريخ الطلب
- `reviewed_at`: تاريخ المراجعة
- `reviewed_by`: المراجع
- `rejection_reason`: سبب الرفض
- `notes`: ملاحظات إضافية

### 2. الخدمات المحدثة

#### dataUpdateService.ts
- `submitDataUpdateRequest()`: إرسال طلب تحديث شامل للبيانات
- `getUpdateRequests()`: الحصول على طلبات التحديث
- `approveDataUpdate()`: الموافقة على طلب التحديث وتطبيقه
- `rejectDataUpdate()`: رفض طلب التحديث مع ذكر السبب
- `canUpdateField()`: التحقق من إمكانية تحديث حقل معين

### 3. المكونات الجديدة

#### UpdateDataForm.tsx
نموذج شامل لتحديث البيانات الشخصية:
- تحديث رقم الهاتف والواتساب
- تحديث العنوان
- تحديث المهنة وعدد أفراد الأسرة
- تحديث الحالة الاجتماعية والمستوى الاقتصادي
- التحقق من كلمة المرور قبل الحفظ
- إرسال الطلب للمراجعة من الإدارة

#### AccountStatusCard.tsx
عرض شامل لحالة حساب المستفيد:
- عرض حالة التوثيق مع مؤشر بصري ملون
  - أخضر: موثق
  - أصفر: قيد المراجعة
  - أحمر: مرفوض/يحتاج تحديث
- عرض حالة الأهلية
  - أخضر: مؤهل
  - أزرق: يحتاج تحديث بيانات
  - رمادي: غير مؤهل حالياً
- عرض المؤسسات المقترحة بناءً على الموقع
- زر سريع لتحديث البيانات عند الحاجة

#### PackagesListWithFilters.tsx
قائمة متطورة لعرض الطرود:
- فلترة حسب الحالة (الكل، المستلمة، قيد التوصيل، القادمة، قيد الانتظار)
- بحث نصي في اسم الطرد أو الوصف أو رقم التتبع
- عرض معلومات تفصيلية لكل طرد
- عرض رقم التتبع الفريد
- عرض التاريخ المتوقع للتسليم
- مؤشرات بصرية ملونة للحالات المختلفة

#### MyDataTab.tsx (محدث)
عرض البيانات الشخصية بشكل قراءة فقط:
- عرض جميع البيانات الأساسية
- عرض بيانات الاتصال
- زر "تحديث البيانات" للانتقال لنموذج التحديث
- تنبيهات واضحة للحقول المقفلة

### 4. تحديثات BeneficiaryPortal

#### تبويبات جديدة:
1. **تبويبة حالة الحساب** (الافتراضية عند الدخول)
   - عرض حالة التوثيق والأهلية
   - المؤسسات المقترحة
   - زر سريع لتحديث البيانات

2. **تبويبة الطرود** (محسّنة)
   - فلاتر متقدمة
   - بحث نصي
   - عرض تفصيلي مع رقم التتبع

3. **تبويبة بياناتي** (محسّنة)
   - عرض قراءة فقط
   - زر للانتقال لنموذج التحديث
   - ملاحظات واضحة عن السياسات

4. **تبويبة النشاطات** (جاهزة للتطوير)
   - عرض سجل نشاط المستفيد
   - الإشعارات

### 5. تحسينات الأمان

- التحقق من كلمة المرور قبل أي تحديث
- قفل رقم الهاتف بعد أول إدخال
- منع تعديل الحقول الحساسة (الاسم، رقم الهوية)
- سجل كامل لجميع محاولات التحديث
- مراجعة إدارية لجميع التحديثات

### 6. تحسينات تجربة المستخدم

- واجهة عربية كاملة مع دعم RTL
- مؤشرات بصرية ملونة واضحة
- رسائل خطأ ونجاح واضحة
- تلميحات ومساعدة في كل خطوة
- تصميم متجاوب على جميع الأجهزة
- تحميل سريع مع إدارة حالة محسّنة

## التدفقات الرئيسية

### 1. تدفق التسجيل لأول مرة:
1. المستفيد يدخل رقم الهوية في صفحة البحث
2. إذا لم يكن موجوداً، يُطلب منه التسجيل
3. ملء جميع البيانات المطلوبة
4. في النهاية، إنشاء كلمة مرور من 6 أرقام
5. تسجيل دخول تلقائي والانتقال للوحة التحكم

### 2. تدفق تسجيل الدخول:
1. المستفيد يدخل رقم الهوية
2. إذا كان لديه حساب، يُطلب منه كلمة المرور
3. بعد التحقق، الانتقال مباشرة للوحة التحكم
4. عرض التبويبات مباشرة بدون خطوات إضافية

### 3. تدفق تحديث البيانات:
1. المستفيد يضغط على "تحديث البيانات"
2. يملأ النموذج بالبيانات الجديدة
3. يُطلب منه كلمة المرور للتأكيد
4. إرسال الطلب للمراجعة
5. الإدارة تراجع وتوافق أو ترفض
6. المستفيد يُشعر بالنتيجة

## الاستخدام للإدارة

### مراجعة طلبات التحديث:
```typescript
// في لوحة تحكم الإدارة
const requests = await dataUpdateService.getUpdateRequests(undefined, 'pending');

// للموافقة
await dataUpdateService.approveDataUpdate(
  requestId,
  'اسم_المراجع',
  'ملاحظات اختيارية'
);

// للرفض
await dataUpdateService.rejectDataUpdate(
  requestId,
  'اسم_المراجع',
  'سبب الرفض',
  'ملاحظات إضافية'
);
```

### تحديث حالة التوثيق:
```typescript
// تحديث حالة التوثيق
await supabase
  .from('beneficiaries')
  .update({
    verification_status: 'verified',
    verification_notes: 'تم التحقق من جميع المستندات'
  })
  .eq('id', beneficiaryId);
```

### تحديث حالة الأهلية:
```typescript
// تحديث حالة الأهلية
await supabase
  .from('beneficiaries')
  .update({
    qualification_status: 'qualified',
    qualification_notes: 'مؤهل للحصول على المساعدات'
  })
  .eq('id', beneficiaryId);
```

### اقتراح مؤسسات:
```typescript
// اقتراح مؤسسات بناءً على الموقع
await supabase
  .from('beneficiaries')
  .update({
    suggested_organizations_ids: ['org-id-1', 'org-id-2', 'org-id-3']
  })
  .eq('id', beneficiaryId);
```

## الخطوات التالية المقترحة

1. **تطوير تبويبة النشاطات**
   - عرض سجل كامل للنشاطات
   - الإشعارات في الوقت الفعلي

2. **تطوير صفحة إدارة طلبات التحديث**
   - واجهة للإدارة لمراجعة الطلبات
   - إمكانية الموافقة أو الرفض بنقرة واحدة
   - إحصائيات عن الطلبات

3. **نظام إشعارات متقدم**
   - إشعارات فورية عند تغيير الحالات
   - إشعارات واتساب تلقائية
   - إشعارات SMS

4. **تقارير وإحصائيات**
   - تقرير بالمستفيدين حسب حالة التوثيق
   - تقرير بالمستفيدين حسب حالة الأهلية
   - تقرير بطلبات التحديث

5. **تحسينات إضافية**
   - إمكانية رفع مستندات إضافية
   - التوقيع الرقمي على المستندات
   - نظام استرداد كلمة المرور
   - التحقق بخطوتين (2FA)

## الملفات المعدلة/الجديدة

### قاعدة البيانات:
- `supabase/migrations/20251110121101_add_account_status_and_data_updates.sql`

### الخدمات:
- `src/services/dataUpdateService.ts` (محدث)

### المكونات الجديدة:
- `src/components/portal/UpdateDataForm.tsx`
- `src/components/portal/AccountStatusCard.tsx`
- `src/components/portal/PackagesListWithFilters.tsx`

### المكونات المحدثة:
- `src/components/BeneficiaryPortal.tsx`
- `src/components/portal/MyDataTab.tsx`

### الأنواع:
- `src/types/database.ts` (محدث)

## الخلاصة

تم تطوير نظام شامل ومتكامل لإدارة حسابات المستفيدين يوفر:
- تجربة مستخدم سلسة وواضحة
- أمان عالٍ للبيانات
- مرونة في التحديث مع مراقبة إدارية
- واجهة عربية كاملة بتصميم احترافي
- تتبع كامل لجميع العمليات

النظام جاهز للاستخدام ويمكن البناء عليه لإضافة ميزات إضافية في المستقبل.
